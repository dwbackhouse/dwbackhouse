QW Scripts



'--- Written by David Backhouse 2014



 



Option Explicit



dim conn1,RS1,conn2,RS2,SQL,i,tag, ID, StartDT, FinishDT,
QWfile2, QWMisc, EndDateTime, BegDateTime, RTCIS_Username,RTCIS_Password,
Last_or_Latest_option



 



'----------------------------



'RTCIS Login Credentials



 


 



RTCIS_Username="RTCIS_REPORT4"



RTCIS_Password="7GBs!d-W"



 



 



'---- DO NOT CHANGE - TEMPLATE BELOW -----



 



'RTCIS_Username="RTCIS_REPORT4"



'RTCIS_Password="7GBs!d-W"



 



'---------------------------



 



 



'Function QW_BEFOREDISPLAY (QWFunction)



Function QWADD_BeforeUpdate(QWFunction)



 



If QWFunction <>"A" Then Exit Function



 



'Open RTCIS Connection



 



        Set
conn1=CreateObject("ADODB.Connection")



        Set
RS1=CreateObject("ADODB.RecordSet")



       
conn1.ConnectionString="DSN=LDLXRTCIS;UID="&RTCIS_Username&";PWD="&RTCIS_Password&";DBQ=lonlxrtcis.eu.pg.com;DBA=W;APA=T;EXC=F;FEN=T;QTO=T;FRC=10;FDL=10;LOB=T;RST=T;BTD=F;BNF=F;BAM=IfAllSuccessful;NUM=NLS;DPM=F;MTS=T;MDI=F;CSR=F;FWC=F;FBS=64000;TLO=O"



        conn1.Open



 



'Open InSQL Connection



 



        Set
conn2=CreateObject("ADODB.Connection")



        Set
RS2=CreateObject("ADODB.RecordSet")



       
conn2.ConnectionString="Provider=SQLOLEDB.1;Password=wwUser;Persist
Security Info=True;User ID=wwUser;Initial Catalog=Runtime;Data
Source=143.38.190.36"



        conn2.Open



 



 



' Define the datetime range to query



 



       Set QWfile2 =
CreateObject("QWaccessClass.QWAccess")



       QWFile2.OpenFile
QWFile.Filename



       QWfile2.SeekLast



       QWfile2.GetPrev



 



'Create tool to handle datetime formatting



   
           
  Set QWMisc = CreateObject("QWTool.Misc")



 



'Last_or_Latest_option = MsgBox ("Do you want to query
the last 12hours from now (Yes) or 12 hours after the finish time of the last
record at "& QWMisc.Format(QWfile2.Value(0),"yyyy-mm-dd
hh:mm:ss")&" (No)?", vbYesNo, "Last or Latest
Record")



 



'Select Case Last_or_Latest_option



 



'Case vbYes



 



'              
EndDateTime = Now



'              
BegDateTime = EndDateTime - (12/24)



 



 



'Case vbNo



 



       BegDateTime=QWfile2.Value(0)



       EndDateTime=
BegDateTime + (12/24)



  



'End Select



 



               
StartDT = QWMisc.Format(BegDateTime,"yyyy-mm-dd hh:mm:ss")



               
FinishDT = QWMisc.Format(EndDateTime,"yyyy-mm-dd hh:mm:ss")



 



'  
            StartDT =
InputBox("Confirm Start Datetime YYYY-MM-DD HH:MM:SS","Enter Run
Start time",StartDT)



' 
            
FinishDT = InputBox("Confirm Finish Datetime YYYY-MM-DD
HH:MM:SS","Enter Run Finish time",FinishDT)



 



'Msgbox("Queried between "&StartDT&"
and "&FinishDT)



 



Qwfile.Value(1)=
QWMisc.Format(FinishDT,"yyyy-mm-dd")



Qwfile.Value(2)=
QWMisc.Format(FinishDT,"hh:mm:ss")



 



For i=3 to QWfile.Fields.Count

ID=LEFT(QwFile.Fields(i).Category,3)
    If ID="LIW" Then
tag="AD_DCON"&RIGHT(QwFile.Fields(i).Category,4)&"_ACT"
SQL="SET QUOTED_IDENTIFIER OFF SELECT * FROM OPENQUERY(INSQL, ""SELECT
sum(["&tag&"])/3600 FROM WideHistory WHERE wwRetrievalMode =
'Cyclic' AND wwResolution = 1000 AND wwVersion = 'Latest' AND DateTime >=
'"&StartDT&"' AND DateTime <=
'"&FinishDT&"'"")"
RS2.Open
SQL,conn2

QwFile.Value(i)=RS2.Fields(0).Value



        RS2.Close



 



 



    ElseIf ID="RTS" Then



 



     
tag=RIGHT(QwFile.Fields(i).Category,6)



 



        SQL="SELECT
sum(SYSTRN.TRNQTY) FROM LIVE3.SYSDTL SYSDTL, INTLIV1.SYSTRN SYSTRN,
INTLIV1.USERS USERS WHERE (SYSTRN.TRNTYP='LINUSE') AND
(SYSTRN.SYSDAT>{ts'"&StartDT&"'}) AND
(SYSTRN.SYSDAT<{ts '"&FinishDT&"'}) AND
(SYSTRN.TRNSEQ=SYSDTL.TRNSEQ) AND (SYSTRN.TECHID=USERS.USER_ID) And
(SYSDTL.LOCATN='"&tag&"')"            




        RS1.Open
SQL,conn1



 



           
If RS1.Fields(0).Value>0 Then



           
Qwfile.Value(i)=RS1.Fields(0).Value



           
Else



           
Qwfile.Value(i)= 0



           
End If



 



        RS1.Close



 



    Else



     



    End If



 



Next



 



Qwfile.Value(QWfile.Fields.Count)="Query run manually
between "&StartDT&" & "&FinishDT&" @
"& Now



 



End Function



 



 



 



Function QWADD_DuringUpdate(QWFunction)



 



   
           
  Set QWMisc = CreateObject("QWTool.Misc")



 



Qwfile.Value(1)= QWMisc.Format(FinishDT,"yyyy-mm-dd")



Qwfile.Value(2)=
QWMisc.Format(FinishDT,"hh:mm:ss")



 



 



End Function



 



'------ Created to fill the gap in records---------



 



'Function QWADD_BeforeUpdate(QWFunction)



 



'Open RTCIS Connection



 



'        Set
conn1=CreateObject("ADODB.Connection")



'        Set
RS1=CreateObject("ADODB.RecordSet")



'       
conn1.ConnectionString="DSN=LDLXRTCIS;UID="&RTCIS_Username&";PWD="&RTCIS_Password&";DBQ=lonlxrtcis.eu.pg.com;DBA=W;APA=T;EXC=F;FEN=T;QTO=T;FRC=10;FDL=10;LOB=T;RST=T;BTD=F;BNF=F;BAM=IfAllSuccessful;NUM=NLS;DPM=F;MTS=T;MDI=F;CSR=F;FWC=F;FBS=64000;TLO=O"



'        conn1.Open



 



'Open InSQL Connection



 



'        Set
conn2=CreateObject("ADODB.Connection")



'        Set
RS2=CreateObject("ADODB.RecordSet")



'        conn2.ConnectionString="Provider=SQLOLEDB.1;Password=wwUser;Persist
Security Info=True;User ID=wwUser;Initial Catalog=Runtime;Data
Source=143.38.190.36"



'        conn2.Open



 



 



' Define the datetime range to query



 



'       Set QWfile2 =
CreateObject("QWaccessClass.QWAccess")



'       QWFile2.OpenFile
QWFile.Filename



'       QWfile2.SeekLast



'       QWfile2.GetPrev



 



               
'Create tool to handle datetime formatting



'   
            Set QWMisc =
CreateObject("QWTool.Misc")



 



 



'       BegDateTime=QWfile2.Value(0)



'       EndDateTime=
BegDateTime + (12/24)



  



 



'              
StartDT = QWMisc.Format(BegDateTime,"yyyy-mm-dd hh:mm:ss")



'              
FinishDT = QWMisc.Format(EndDateTime,"yyyy-mm-dd hh:mm:ss")



 



'Qwfile.Value(1)= QWMisc.Format(FinishDT,"yyyy-mm-dd")



'Qwfile.Value(2)=
QWMisc.Format(FinishDT,"hh:mm:ss")



 



'If EndDatetime<now Then



 



'For i=3 to QWfile.Fields.Count



 



'ID=LEFT(QwFile.Fields(i).Category,3)



 



'    If ID="LIW" Then



         



'     
tag="AD_DCON"&RIGHT(QwFile.Fields(i).Category,4)&"_ACT"



'        



'        SQL="SET
QUOTED_IDENTIFIER OFF SELECT * FROM OPENQUERY(INSQL, ""SELECT
sum(["&tag&"])/3600 FROM WideHistory WHERE wwRetrievalMode =
'Cyclic' AND wwResolution = 1000 AND wwVersion = 'Latest' AND DateTime >=
'"&StartDT&"' AND DateTime <=
'"&FinishDT&"'"")"



'        RS2.Open
SQL,conn2



'       
QwFile.Value(i)=RS2.Fields(0).Value



'        RS2.Close



 



 



'   ElseIf ID="RTS" Then



'



'     
tag=RIGHT(QwFile.Fields(i).Category,6)



 



'        SQL="SELECT
sum(SYSTRN.TRNQTY) FROM LIVE3.SYSDTL SYSDTL, INTLIV1.SYSTRN SYSTRN,
INTLIV1.USERS USERS WHERE (SYSTRN.TRNTYP='LINUSE') AND
(SYSTRN.SYSDAT>{ts'"&StartDT&"'}) AND
(SYSTRN.SYSDAT<{ts '"&FinishDT&"'}) AND (SYSTRN.TRNSEQ=SYSDTL.TRNSEQ)
AND (SYSTRN.TECHID=USERS.USER_ID) And
(SYSDTL.LOCATN='"&tag&"')"            




'        RS1.Open
SQL,conn1



 



'           
If RS1.Fields(0).Value>0 Then



'           
Qwfile.Value(i)=RS1.Fields(0).Value



'           
Else



'           
Qwfile.Value(i)= 0



'           
End If



'



'        RS1.Close



 



'    Else



     



'    End If



 



'Next



 



'Else



 



'Exit Function



 



'End if



 



'Qwfile.Value(QWfile.Fields.Count)="Query run
Automatically between "&StartDT&" &
"&FinishDT&" @ "& Now



 



'End Function



 



 



'-----------------------------------------------------------------



 



 



'Function QWADD_BeforeUpdate(QWFunction)



 



'Open RTCIS Connection



 



'        Set
conn1=CreateObject("ADODB.Connection")



'        Set
RS1=CreateObject("ADODB.RecordSet")



' conn1.ConnectionString="DSN=LDLXRTCIS;UID="&RTCIS_Username&";PWD="&RTCIS_Password&";DBQ=lonlxrtcis.eu.pg.com;DBA=W;APA=T;EXC=F;FEN=T;QTO=T;FRC=10;FDL=10;LOB=T;RST=T;BTD=F;BNF=F;BAM=IfAllSuccessful;NUM=NLS;DPM=F;MTS=T;MDI=F;CSR=F;FWC=F;FBS=64000;TLO=O"



'        conn1.Open



 



'Open InSQL Connection



 



'        Set
conn2=CreateObject("ADODB.Connection")



'        Set
RS2=CreateObject("ADODB.RecordSet")



'       
conn2.ConnectionString="Provider=SQLOLEDB.1;Password=wwUser;Persist
Security Info=True;User ID=wwUser;Initial Catalog=Runtime;Data
Source=143.38.190.36"



'        conn2.Open



 



'For i=3 to QWfile.Fields.Count



 



'ID=LEFT(QwFile.Fields(i).Category,3)



 



'    If ID="LIW" Then



         



'     
tag="AD_DCON"&RIGHT(QwFile.Fields(i).Category,4)&"_ACT"



        



'        SQL="SET
QUOTED_IDENTIFIER OFF SELECT * FROM OPENQUERY(INSQL, ""SELECT
sum(["&tag&"])/3600 FROM WideHistory WHERE wwRetrievalMode =
'Cyclic' AND wwResolution = 1000 AND wwVersion = 'Latest' AND DateTime >=
DateAdd(hh,-12,GetDate()) AND DateTime <= GetDate()"")"



'        RS2.Open
SQL,conn2



'       
QwFile.Value(i)=RS2.Fields(0).Value



'        RS2.Close



 



 



'    ElseIf ID="RTS" Then



 



'     
tag=RIGHT(QwFile.Fields(i).Category,6)



 



'        SQL="SELECT
sum(SYSTRN.TRNQTY) FROM LIVE3.SYSDTL SYSDTL, INTLIV1.SYSTRN SYSTRN, INTLIV1.USERS
USERS WHERE (SYSTRN.TRNTYP='LINUSE') AND (SYSTRN.SYSDAT>SYSDATE-1/2) AND
(SYSTRN.TRNSEQ=SYSDTL.TRNSEQ) AND (SYSTRN.TECHID=USERS.USER_ID) And
(SYSDTL.LOCATN='"&tag&"')"      




'        RS1.Open
SQL,conn1



 



'           
If RS1.Fields(0).Value>0 Then



'           
Qwfile.Value(i)=RS1.Fields(0).Value



'           
Else



'           
Qwfile.Value(i)= 0



'           
End If



'



'        RS1.Close



       



 



'    Else



     



 



'    End If



 



'Next



 



'Qwfile.Value(QWfile.Fields.Count)="Query run in Auto
by QWSchedule & QWADD"



 



'End Function





 



Option Explicit



Dim
conn,RS,SQL,UniqueID,LastUniqueID,QWFile2,i,Feed,BatchWT,HEDPW,LASW,EW_BASEW,SILICATEW,SULPHATE,WATER,SCRAP,SCRAPW,REMELT,REMELTW



 



Function QW_BeforeDisplay(QWFunction)



 



 



End Function



 



 



Function QW_BeforeUpdate(QWFunction)



 



QwFile.Value(20)=""



 



End Function



 



 



Function QWADD_BeforeUpdate(QWFunction)



 



' Opening the Connection to the CCS Server



 



        Set
conn=CreateObject("ADODB.Connection")



        Set
RS=CreateObject("ADODB.RecordSet")



       
conn.ConnectionString="DRIVER=SQL Server;SERVER=155.121.108.1;UID=enguser;PWD=engadmin;APP=Microsoft
Office 2010;WSID=CNU2121TL5-W7;DATABASE=msg_reports_new"



       
conn.ConnectionTimeout=30



       
conn.CommandTimeout=30



        conn.Open



 



       If conn.State = 0 Then



         QWADD_BeforeUpdate="CANCEL"



         Exit
Function



       End If



 



' Find Last UniqueID Based on Highest CompleteTime



 



       SQL="SELECT TOP 1
UniqueID FROM msg_reports_new.dbo.MaterialHis ORDER BY CompleteTime DESC"



      
QwFile.Value(QWfile.fields.Count)=SQL



       RS.Open SQL,conn



      
UniqueID=RS.Fields(0).Value



       RS.Close



 



'Collect Previous Record UniqueID to Compare



 



       Set QWfile2 =
CreateObject("QWaccessClass.QWAccess")



       QWFile2.OpenFile
QWFile.Filename



       QWfile2.SeekLast



       QWfile2.GetPrev



      
LastUniqueID=QWfile2.Value(5)



 



'If Previous Record UniqueId is Blank Then scroll up to find
Latest Non-Null UniqueId



 



       While
LastUniqueID=""



         
QWFile2.GetRecord QWFile2.RecordNo-1



         
LastUniqueID=QWfile2.Value(5)



       Wend



 



'Cancel Function if LastUniqueID from QW = UniqueID from
SQL, or if QW ID is blank



 



       If
LastUniqueID=UniqueID Then 



        QWADD_BeforeUpdate="CANCEL"



         Exit
Function



       End If



 



' Store Newest UniqueId



 



       
QwFile.Value(5)=UniqueID



 



' Collect CampaignID



 



        SQL="SELECT
top 1 CampaignID  FROM msg_reports_new.dbo.MaterialHis Where
UniqueID="&UniqueID



 



       
QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn



       
QwFile.Value(3)=RS.Fields(0).Value    



        RS.Close



 



' Collect BatchID



 



        SQL="SELECT
top 1 BatchID  FROM msg_reports_new.dbo.MaterialHis Where
UniqueID="&UniqueID



        RS.Open SQL,conn



       
QwFile.Value(QWfile.fields.Count)=SQL



       
QwFile.Value(4)=RS.Fields(0).Value



        RS.Close



 



For i=6 to QWfile.fields.Count



 



  IF LEFT(QwFile.Fields(i).Category,4)="FEED"
Then



 



    'Collect All the Feed Deviations



 



        Feed=MID(QwFile.Fields(i).Category,6)



 



        SQL="SELECT
(AmountCharged-CSP)/CSP*100 FROM msg_reports_new.dbo.MaterialHis WHERE
UniqueID="&UniqueID&" And Feed='"&Feed&"'
And CSP>0"



       
QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn



        IF RS.EOF=False
Then 



           QwFile.Value(i)=RS.Fields(0).Value




        End If



        RS.Close 



 



  ElseIf QwFile.Fields(i).Category = "Q1"
Then



 



      'Total batch weight End of
Batch



 



        SQL="SELECT
Top 1 AmountDumped FROM msg_reports_new.dbo.MaterialHis WHERE
(MaterialHis.UniqueID="&UniqueID&") AND
Operation='CRU_DUMPING:1' Order by AmountDumped DESC"



       
QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn



        IF RS.EOF=False
Then        



           QwFile.Value(i)=RS.Fields(0).Value



          
BatchWT=RS.Fields(0).Value



        End If



        RS.Close 



 



  ElseIf QwFile.Fields(i).Category = "Q2"
Then



 



      'Dry Scrap % of Crutcher
Weight



 



        SQL="SELECT
sum(AmountCharged) FROM msg_reports_new.dbo.MaterialHis WHERE
(MaterialHis.UniqueID="&UniqueID&") AND ( Feed='NORTH_SCRAP'
OR Feed='SOUTH_SCRAP')"



       
QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn



        IF RS.EOF=False
Then 



       



         SCRAP=RS.Fields(0).Value



        
QwFile.Value(i)=SCRAP*100/BatchWT



        



        End If



        RS.Close 



 



  ElseIf QwFile.Fields(i).Category = "Q3"
Then



 



      'Wet Scrap % of Crutcher
Weight



 



        SQL="SELECT
sum(AmountCharged) FROM msg_reports_new.dbo.MaterialHis WHERE
(MaterialHis.UniqueID="&UniqueID&") AND (
Feed='REMELT')"



       
QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn



        IF RS.EOF=False
Then 



 



          
REMELT=RS.Fields(0).Value    



           QwFile.Value(i)=REMELT*100/BatchWT



 



        End If



        RS.Close 



 



  ElseIf QwFile.Fields(i).Category = "Q4"
Then



 



      'Calculated CMM%



 



  



        SQL="SELECT
sum(AmountCharged) FROM msg_reports_new.dbo.MaterialHis WHERE
(MaterialHis.UniqueID="&UniqueID&") AND (
Feed='EW_BASE')" 



        QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn 



        IF
RS.EOF=False Then



          
EW_BASEW=0.60*RS.Fields(0).Value



        End If



               
RS.Close 



 



        SQL="SELECT
sum(AmountCharged) FROM msg_reports_new.dbo.MaterialHis WHERE
(MaterialHis.UniqueID="&UniqueID&") AND (
Feed='SILICATE')" 



        QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn 



        IF
RS.EOF=False Then



               
   SILICATEW=0.55*RS.Fields(0).Value 



        End If



               
RS.Close 



 



        SQL="SELECT
sum(AmountCharged) FROM msg_reports_new.dbo.MaterialHis WHERE
(MaterialHis.UniqueID="&UniqueID&") AND ( Feed='LAS')" 



        QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn 



        IF
RS.EOF=False Then 



               
    LASW=0.51*RS.Fields(0).Value 



        End If



               
RS.Close 



 



        SQL="SELECT
sum(AmountCharged) FROM msg_reports_new.dbo.MaterialHis WHERE
(MaterialHis.UniqueID="&UniqueID&") AND ( Feed='HEDP')" 



        QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn 



        IF
RS.EOF=False Then



               
    HEDPW=0.70*RS.Fields(0).Value 



        End If



               
RS.Close 



 



        SQL="SELECT
sum(AmountCharged) FROM msg_reports_new.dbo.MaterialHis WHERE
(MaterialHis.UniqueID="&UniqueID&") AND (
Feed='REMELT')" 



        QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn 



        IF
RS.EOF=False Then



               
    REMELTW=0.70*RS.Fields(0).Value 



        End If



               
RS.Close 



 



        SQL="SELECT
sum(AmountCharged) FROM msg_reports_new.dbo.MaterialHis WHERE
(MaterialHis.UniqueID="&UniqueID&") AND ( Feed='NORTH_SCRAP'
OR Feed='SOUTH_SCRAP')" 



        QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn 



        IF
RS.EOF=False Then



               
    SCRAPW=0.10*RS.Fields(0).Value 



        End If



               
RS.Close 



 



        SQL="SELECT
sum(AmountCharged) FROM msg_reports_new.dbo.MaterialHis WHERE
(MaterialHis.UniqueID="&UniqueID&") AND ( Feed='WATER' OR
Feed='CITY WATER' OR Feed='FEED-SULPHATE WATER')" 



        QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn 



        IF
RS.EOF=False Then



               
    WATER=RS.Fields(0).Value 



        End If



               
RS.Close 



 



          
QwFile.Value(i)=(EW_BASEW+SILICATEW+LASW+HEDPW+REMELTW+SCRAPW+WATER)*100/BatchWT



 



 



  ElseIf QwFile.Fields(i).Category = "Q5"
Then



 



      'Collect End of Batch
Temperature in DegC



 



        SQL="SELECT
UnitTemp FROM msg_reports_new.dbo.MaterialHis Where UniqueID="&UniqueID&"
AND UnitTemp IS NOT NULL"



       
QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn



        IF RS.EOF=False
Then        



           QwFile.Value(i)=RS.Fields(0).Value



        End If



        RS.Close 



 



  ElseIf QwFile.Fields(i).Category = "Q6"
Then



 



      'Total Mixing Time in Seconds



 



        SQL="SELECT
TimeMixed FROM msg_reports_new.dbo.MaterialHis Where
UniqueID="&UniqueID&" AND TimeMixed IS NOT NULL"



       
QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn



        IF RS.EOF=False
Then        



           QwFile.Value(i)=RS.Fields(0).Value



        End If



        RS.Close 



 



  ElseIF QwFile.Fields(i).Category = "Q7"
Then



 



      'Agitator RPM



 



        SQL="SELECT
AgitatorSpeed FROM msg_reports_new.dbo.MaterialHis Where
UniqueID="&UniqueID&" AND AgitatorSpeed IS NOT NULL"



       
QwFile.Value(QWfile.fields.Count)=SQL



        RS.Open SQL,conn



        IF RS.EOF=False
Then        



           QwFile.Value(i)=RS.Fields(0).Value



        End If



        RS.Close 



 



  ElseIF QwFile.Fields(i).Category = "Q8"
Then



 



 



  End If



 



Next



 



'Clear all the SQL coding from the comments field - Assumes
no errors occured



 



      
QwFile.Value(QWfile.fields.Count)=""



       'QwFile.Value(QWfile.fields.Count)="Water
Contents:EW
BaseW="&EW_BASEW&",Silicate="&SILICATE&",LAS="&LASW&",HEDP="&HEDPW&",REMELT="&REMELTW&",SCRAP="&SCRAPW&",WATER="&WATER&""



 



 



End Function





 


